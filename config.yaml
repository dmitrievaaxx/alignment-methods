# config.yaml
name: with-right-version-vllm
desc: Simple working version

cmd: |
  export PYTHONIOENCODING=utf-8
  export LANG=C.UTF-8
  export PIP_ROOT_USER_ACTION=ignore
  export USE_FLASH_ATTENTION=0
  export TRANSFORMERS_USE_FLASH_ATTENTION=0
  export WANDB_MODE=offline
  export WANDB_DIR=/job/output/wandb

  export CLEARML_API_HOST=https://api.clear.ml
  export CLEARML_WEB_HOST=https://app.clear.ml  
  export CLEARML_FILES_HOST=https://files.clear.ml
  export CLEARML_API_ACCESS_KEY="1115V427IJEV3GB0UZMCHFD8XPCLO9"
  export CLEARML_API_SECRET_KEY="3k9gBL0lsd9iKBzHvaUpjwXOYtgI7HObE9De98qMDnrBQ0WZQrwITY9Q2PcR4kWWmPs"

  echo "ðŸ“¦ Installing packages..."
  pip install --upgrade pip
  pip install torch==2.5.1+cu121 torchvision==0.20.1+cu121 torchaudio==2.5.1+cu121 --index-url https://download.pytorch.org/whl/cu121
  pip install packaging ninja wheel setuptools psutil
  pip install flash-attn>=2.5.0 --no-build-isolation --no-cache-dir
  pip install accelerate transformers datasets peft wandb hydra-core omegaconf tensordict ray codetiming
  pip install wandb --upgrade
  pip install clearml
  pip install vllm --extra-index-url https://wheels.vllm.ai/stable

  mkdir -p /job
  cp -r ${VERL_DIR} /job/verl
  mkdir -p /job/verl_config
  cp /job/verl/verl/trainer/sft_qwen_1.5b.yaml /job/verl_config/
  python ${UPDATE_CONFIG} /job/verl_config sft_qwen_1.5b

  mkdir -p /job/output/wandb
  mkdir -p /job/output/checkpoints

  cd /job/verl && PYTHONPATH=/job/verl:$PYTHONPATH python ${DISABLE_FLASH_ATTN} && PYTHONPATH=/job/verl:$PYTHONPATH torchrun --standalone --nnodes=1 --nproc_per_node=1 verl/trainer/fsdp_sft_trainer.py --config-path /job/verl_config --config-name sft_qwen_1.5b data.train_files="[${TRAIN_DATA}]" data.val_files="[${VAL_DATA}]"

  echo "ðŸ•’ Waiting for file sync..."
  sync
  sleep 30

  echo "ðŸ“ Final output structure:"
  find /job/output -type f -name "*.json" | head -10
  find /job/output -type f -name "*.txt" | head -10
  du -sh /job/output/*

  echo "ðŸ“¦ Preparing files for upload..."
  mkdir -p ${OUTPUT_DIR}

  find /job/output/wandb -type l -delete || true
  rm -rf /job/output/wandb/wandb/latest-run || true

  cd /job/output
  tar -czf /job/output/output.tar.gz checkpoints wandb training_completed.txt 2>/dev/null || tar -czf /job/output/output.tar.gz checkpoints wandb 2>/dev/null

  cp /job/output/output.tar.gz ${OUTPUT_DIR}/
  echo "âœ… Archive created: ${OUTPUT_DIR}/output.tar.gz"

  echo "ðŸ“‹ Contents of archive:"
  tar -tf ${OUTPUT_DIR}/output.tar.gz | head -20

  echo "âœ… All files prepared for download"


inputs:
  - train_data.parquet: TRAIN_DATA
  - val_data.parquet: VAL_DATA
  - update_config.py: UPDATE_CONFIG
  - verl: VERL_DIR
  - disable_flash_attn.py: DISABLE_FLASH_ATTN

outputs:
  - output_dir/output.tar.gz: OUTPUT_DIR

cloud-instance-type: g1.1
